<!DOCTYPE html>

<script type="text/javascript">
(function() {
    RED.nodes.registerType('ui_led', {
        category: 'dashboard',
        paletteLabel: 'led',
        color: 'rgb(63, 173, 181)',
        defaults: {
            group: {type: 'ui_group', required: true},
            order: {value: 0},
            label: {value: ''},

            colors: {
                value: [{
                    'color': 'red',
                    'value': false
                },
                {
                    'color': 'green',
                    'value': true
                }
                ], 
                validate: function(colorsValue) {
                    if (!colorsValue) {
                        return false;
                    }
                    // TODO: check for duplicate values
                    for (var index = 0; index < colorsValue.length; index ++) {
                        const colorValue = colorsValue[index];
                        if (!colorValue.color || colorValue.color.length === 0) {
                            console.log("invalid color '" + colorValue.color + "'");
                            return false;
                        }
                        // We're allowing undefined as a valid value
                        // if (colorValue.value === undefined) {
                        //     return false;
                        // }
                    }
                    return true;
                }, 
                required:true
            },

            name: {value: ''}
        },
        inputs: 1,
        inputLabels: "value",
        outputs: 0,
        align: 'right',
        label: function() {
            return this.name || 'led';
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        icon: "led.png",

        oneditprepare: function() {
            function generateValueFormRow(index, value) {
                var container = $('<li/>',{style:"background: #fff; margin:0; padding:8px 0px 0px; border-bottom: 1px solid #ccc;"});
                var row = $('<div/>').appendTo(container);
                var row2 = $('<div/>',{style:"padding-top:5px; padding-left:175px;"}).appendTo(container);
                var row3 = $('<div/>',{style:"padding-top:5px; padding-left:120px;"}).appendTo(container);

                $('<i style="color:#eee; cursor:move; margin-left:3px;" class="node-input-colors-handle fa fa-bars"></i>').appendTo(row);

                var colorClass ="node-input-colors-color"
                if (!value.color) { 
                    colorClass = colorClass + " input-error"; 
                }
                var colorField = $('<input/>', {
                    class: colorClass,
                    type: "text",
                    style: "margin-left: 15px; width: 35%", 
                    placeholder: 'Color', 
                    value:value.color
                }).appendTo(row);

                colorField.keyup(function() {
                    var value = $(this).val();

                    if (value && $(this).hasClass('input-error')) {
                        $(this).removeClass('input-error')
                    }
                    else {
                        if (!value) {
                            $(this).addClass('input-error')
                        }
                    } 
                }); 

                $('<input/>', {
                    class: "node-input-colors-value",
                    type: "text",
                    style: "margin-left:15px; width:30%", 
                    placeholder: 'Value (leave empty for undefined)', 
                    value: value.value
                }).appendTo(row);

                var finalspan = $('<div/>',{style:"display: inline-block; width: 20%;"}).appendTo(row);
                var deleteButton = $('<a/>',{href:"#",class:"editor-button editor-button-small", style:"left:45%; position:relative;"}).appendTo(finalspan);
                $('<i/>',{class:"fa fa-remove"}).appendTo(deleteButton);

                deleteButton.click(function() {
                    container.find(".node-input-colors-color").removeAttr('required')
                    container.css({"background":"#fee"});
                    container.fadeOut(300, function() {
                        $(this).remove();
                    });
                });

                $("#node-input-colors-container").append(container);
            }

            $("#node-input-add-color").click(function() {
                generateValueFormRow($("#node-input-colors-container").children().length + 1, {});
                $("#node-input-colors-container-div").scrollTop($("#node-input-colors-container-div").get(0).scrollHeight);
            });

            if (!this.colors) {
                // TODO: Duplicate from above
                this.colors = [{
                    'color': 'red',
                    'value': false
                },
                {
                    'color': 'green',
                    'value': true
                }];
            }
            
            for (var index = 0; index < this.colors.length; index ++) {
                var color = this.colors[index];
                generateValueFormRow(index + 1, color);
            }

            $( "#node-input-colors-container" ).sortable({
                axis: "y",
                handle:".node-input-colors-handle",
                cursor: "move"
            });
        },
        oneditsave: function() {
            var node = this;

            var colorsElement = $("#node-input-colors-container").children();
            node.colors = [];
            colorsElement.each(function(i) {
                var colorElement = $(this);
                
                var color = colorElement.find(".node-input-colors-color").val();
                var value = colorElement.find(".node-input-colors-value").val();
                var settings = {
                    color: color,
                    value: value
                };
                node.colors.push(settings);
            });
        }
    });
})();
</script>

<script type="text/x-red" data-template-name="ui_led">
    <style>
        .switch {
            position: relative;
            display: inline-block;
            width: 30px;
            height: 18px;
        }
        
        .switch input {display:none;}
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 15px;
            width: 15px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }
        
        input:checked + .slider {
            background-color: #910000;
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }
        
        input:checked + .slider:before {
            -webkit-transform: translateX(11px);
            -ms-transform: translateX(11px);
            transform: translateX(11px);
        }
        
        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }
        
        .slider.round:before {
            border-radius: 50%;
        }
    </style>

    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="icon-tag"></i> Label</label>
        <input type="text" id="node-input-label" placeholder="Label">
    </div>

    <div class="form-row node-input-colors-container-row" style="margin-bottom:0px; width:100%; min-width:520px">
        <label style="vertical-align:top;"><i class="fa fa-list-alt"></i> Fields</label>
        <div style="display:inline-block; width:78%; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;">
          <div style="width:100%; display: inline-block; background-color:#f3f3f3; padding-top:10px; padding-buttom:10px; border-top:0px solid; border-radius:5px 5px 0 0; border-bottom:1px solid #ccc;">
              <div style="width:94%; display:inline-block; margin-left:32px">
                <div style="width:50%; text-align:center; float:left;">Color</div>
                <div style="width:45%; text-align:center; float:left;">Value</div>
              </div>
          </div>
          <div id="node-input-colors-container-div" style=" height: 257px; padding: 5px; overflow-y: scroll;">
            <ol id="node-input-colors-container" style=" list-style-type:none; margin: 0;"></ol>
          </div>
        </div>
    </div>
    <div class="form-row">
        <a href="#" class="editor-button editor-button-small" id="node-input-add-color" style="margin-top: 4px; margin-left: 103px;"><i class="fa fa-plus"></i> <span>Color</span></a>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="ui_led">
    <p>A simple LED status indicator for the Node-RED Dashboard</p>
</script>
